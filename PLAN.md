# Пошаговый план реализации CSV → Parquet (Arrow Go) с жёстким TDD

## Методология
- **TDD (Test-Driven Development)** — центральная стратегия: для каждого компонента и этапа сначала проектируются и реализуются тесты (unit/integration), только затем пишется код.
- Для каждого этапа заранее фиксируются критерии готовности (Definition of Done) и тестовые сценарии.

## 1. Подготовительный этап
- Уточнить требования к поддерживаемым типам данных и структурам (flat, nullable, precision и др.).
- Определить формат пользовательской YAML-схемы (пример, валидные типы, required/optional).
- Составить карту соответствия YAML-типов и типов Arrow.
- Проектировать тестовые сценарии для схемы, маппинга и ошибок.

## 2. SchemaLoader (YAML → Arrow Schema)
- **TDD:**
  - Проектировать и реализовать unit-тесты для парсинга, валидации и маппинга YAML → Arrow Schema (валидные и ошибочные случаи).
  - Определить критерии готовности (корректная обработка всех поддерживаемых и ошибочных схем).
- Реализовать парсер YAML-схемы, маппинг типов и построение arrow.Schema.
- Прогонять тесты после каждого изменения.

## 3. CSVReader + ArrowRecordBatchBuilder
- **TDD:**
  - Проектировать unit-тесты для чтения CSV, преобразования типов, обработки ошибок, batch-аккумуляции.
  - Включить edge-cases: пустые значения, неверные типы, nullable.
- Реализовать стриминговый CSVReader и ArrowRecordBatchBuilder.
- Прогонять тесты после каждого изменения.

## 4. ParquetFileWriter (Arrow → Parquet)
- **TDD:**
  - Проектировать unit-тесты для записи batch-ей Arrow в Parquet, проверки структуры и корректности выходного файла.
  - Сравнивать результат с эталонными Parquet-файлами.
- Реализовать потоковую запись с оптимизацией памяти.
- Прогонять тесты после каждого изменения.

## 5. StorageAdapter (Local/S3)
- **TDD:**
  - Проектировать unit-тесты для записи файлов локально и в S3 (моки, обработка ошибок, multipart upload).
- Реализовать StorageAdapter.
- Прогонять тесты после каждого изменения.

## 6. Orchestration: Convert()
- **TDD:**
  - Проектировать интеграционные тесты (end-to-end: YAML+CSV → Parquet, ошибки на каждом этапе).
  - Определить критерии готовности: успешная обработка валидных данных, корректная реакция на ошибки.
- Реализовать функцию Convert(), объединяющую все компоненты.
- Прогонять тесты после каждого изменения.

## 7. Документация и примеры
- Описать формат YAML-схемы, ограничения, поддерживаемые типы.
- Привести примеры использования (минимальный, edge-cases, S3).
- Обновить README, ARCHITECTURE.md, CONVERSATION.md.
- Добавить тестовые сценарии в документацию, чтобы пользователь мог воспроизвести тесты самостоятельно.

## 8. Производительность и профилирование
- **TDD:**
  - Проектировать тесты для нагрузочного тестирования (большие файлы, разные batch size).
  - Критерии: не превышать лимиты памяти, приемлемое время обработки.
- Провести профилирование, оптимизировать узкие места.
- Зафиксировать рекомендации по параметрам для production.

---

**NB:**
- На каждом этапе: сначала тесты, потом код.
- Все ошибки возвращаются явно, без внутреннего логирования.
- Definition of Done = все тесты зелёные, покрытие edge-cases, критерии готовности выполнены.
